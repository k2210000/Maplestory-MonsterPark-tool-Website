<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çµ‚æ¥µæ€ªç‰©å…¬åœ’-å·¥å…·</title>
  <style>
    :root{
      --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa4b2; --card:#13161c; --card-border:#242a36; --well:#0c0f14;
      --cell:220px; --gap:12px; --radius:14px;
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --fg:#0e1116; --muted:#596273; --card:#ffffff; --card-border:#dfe5ee; --well:#f1f4f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans TC",Arial}
    header{padding:16px 20px;border-bottom:1px solid var(--card-border);position:sticky;top:0;background:rgba(15,17,21,.8);backdrop-filter:blur(8px);display:flex;align-items:center;gap:12px;z-index:2}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .spacer{flex:1}
    button{background:var(--card);color:var(--fg);border:1px solid var(--card-border);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    button:hover{filter:brightness(1.05)}

    main{padding:20px;display:grid;grid-template-columns: 1fr max-content;gap:20px}
    @media (max-width: 1100px){ main{grid-template-columns: 1fr} }

    /* ä¹å®®æ ¼ç›¤é¢ï¼šå¤šå¢åŠ ç¬¬4æ¬„ï¼Œæ”¾æ¯è¡Œçš„ã€Œè¤‡è£½ã€æŒ‰éˆ• */
    .board{
      display:grid;
      grid-template-columns:repeat(3,var(--cell)) auto; /* 3æ ¼ + å³å´æŒ‰éˆ•æ¬„ */
      grid-template-rows:repeat(3,var(--cell));
      gap:var(--gap);
      justify-content:center;
      align-items:start;
    }
    .cell{width:var(--cell);height:var(--cell);background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:10px;position:relative;display:flex;flex-direction:column}
    .cell.active{outline:2px solid #6aa3ff; outline-offset:2px}
    .title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .imgbox{flex:1;display:grid;place-items:center;background:var(--well);border-radius:10px;overflow:hidden;border:1px dashed var(--card-border)}
    .imgbox img{max-width:100%;max-height:100%;object-fit:contain}
    .clear{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center}

    /* å³å´å€™é¸å€ï¼ˆå·¦ä¸‹è§’æ‹–æ›³æŠŠæ‰‹ã€ç¸®åœ–éš¨å¯¬åº¦è®Šå‹•ï¼‰ */
    .pool{position: sticky;top: 76px;background: var(--card);border: 1px solid var(--card-border);border-radius: var(--radius);padding: 12px;resize: both;overflow: auto;direction: rtl;}
    .pool * {direction: ltr;}
    .assign-resizable{width:340px;min-width:260px;max-width:48vw;min-height:240px;max-height:80vh;resize: both;overflow: auto;container-type: inline-size;--tile-size: clamp(88px, 28cqw, 160px);}
    .opts{display:grid;gap:10px;grid-template-columns: repeat(auto-fill, minmax(var(--tile-size), 1fr));}
    .opt{border:1px solid var(--card-border);border-radius:12px;padding:6px;display:flex;flex-direction:column;gap:6px;cursor:pointer;background:var(--well);position:relative}
    .opt .pic{aspect-ratio:1/1;display:grid;place-items:center;overflow:hidden;border-radius:8px;background:var(--card)}
    .opt img{max-width:100%;max-height:100%;object-fit:contain}
    .opt .name{font-size:12px;color:var(--fg);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .opt.used{opacity:.35;filter:saturate(.2);cursor:not-allowed}
    .opt.used::after{content:'å·²ç”¨';position:absolute;top:6px;right:6px;font-size:10px;background:#0008;padding:2px 6px;border-radius:999px;border:1px solid var(--card-border)}

    /* æ¯è¡Œçš„ã€Œè¤‡è£½ä¸Š/ä¸­/ä¸‹æ’ã€æŒ‰éˆ•æ¨£å¼ï¼ˆæ”¾åœ¨ç›¤é¢ç¬¬4æ¬„ï¼‰ */
    .rowcopy{
      align-self:center;
      justify-self:start;
      height:40px;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      white-space:nowrap;
    }

    .theme-toggle{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:3}
    .theme-toggle .icon{font-size:16px}
  </style>
</head>
<body>
  <header>
    <h1>çµ‚æ¥µæ€ªç‰©å…¬åœ’-å·¥å…·</h1>
    <div class="spacer"></div>
    <button id="copyAll">è¤‡è£½å…¨éƒ¨</button>
    <button id="clearAll">æ¸…ç©ºå…¨éƒ¨</button>
  </header>

  <main>
    <section>
      <div class="board" id="board"></div>
    </section>
    <aside>
      <div class="pool assign-resizable">
        <h2>å¯é¸é …ç›®ï¼ˆé»ä¸€ä¸‹æŒ‡æ´¾ï¼‰</h2>
        <div class="opts" id="opts"></div>
      </div>
    </aside>
  </main>

  <button id="themeToggle" class="theme-toggle" title="åˆ‡æ›æ·±/æ·ºè‰²ä¸»é¡Œ">
    <span class="icon" id="themeIcon">ğŸŒ™</span>
    <span id="themeText">æ·±è‰²</span>
  </button>

  <script>
    var TOTAL=9;

    /* åç¨±â†’ç°¡ç¨±å°ç…§ï¼ˆå¯ä¾ä½ ç¿’æ…£èª¿æ•´ï¼‰ */
    var NAME_SHORT = {
      "æœªçŸ¥çš„ç²¾éŠ³åŠé½’è™":"é»‘è™",
      "æœªçŸ¥çš„å§‹ç¥–é³¥":"ç´…é³¥",
      "æœªçŸ¥çš„è®Šç•°å²èŠå§†":"ç´«å²",
      "æœªçŸ¥çš„é›·é›»é³¥":"ç¶ é³¥",
      "æœªçŸ¥çš„è®è›‡":"ç´…è›‡",
      "æœªçŸ¥çš„ç¶ æ°´éˆ":"ç¶ å²",
      "æœªçŸ¥çš„åŠé½’è™":"è—è™",
      "æœªçŸ¥çš„æ¯’è›‡":"ç¶ è›‡",
      "ç¥­å£‡":"ç¥­å£‡"
    };

    var OPTIONS_FALLBACK = [
      { "id": 1, "name": "æœªçŸ¥çš„ç²¾éŠ³åŠé½’è™", "image": "images/æœªçŸ¥çš„ç²¾éŠ³åŠé½’è™.png" },
      { "id": 2, "name": "æœªçŸ¥çš„å§‹ç¥–é³¥",     "image": "images/æœªçŸ¥çš„å§‹ç¥–é³¥.png" },
      { "id": 3, "name": "æœªçŸ¥çš„è®Šç•°å²èŠå§†", "image": "images/æœªçŸ¥çš„è®Šç•°å²èŠå§†.png" },
      { "id": 4, "name": "æœªçŸ¥çš„é›·é›»é³¥",     "image": "images/æœªçŸ¥çš„é›·é›»é³¥.png" },
      { "id": 5, "name": "æœªçŸ¥çš„è®è›‡",       "image": "images/æœªçŸ¥çš„è®è›‡.png" },
      { "id": 6, "name": "æœªçŸ¥çš„ç¶ æ°´éˆ",     "image": "images/æœªçŸ¥çš„ç¶ æ°´éˆ.png" },
      { "id": 7, "name": "æœªçŸ¥çš„åŠé½’è™",     "image": "images/æœªçŸ¥çš„åŠé½’è™.png" },
      { "id": 8, "name": "æœªçŸ¥çš„æ¯’è›‡",       "image": "images/æœªçŸ¥çš„æ¯’è›‡.png" }
    ];

    /* ç‹€æ…‹å„²å­˜ */
    var assignKey='mch_assign';
    var activeKey='mch_active';
    function loadAssign(){ try{ return JSON.parse(localStorage.getItem(assignKey)||'{}'); }catch(e){ return {}; } }
    function saveAssign(m){ try{ localStorage.setItem(assignKey,JSON.stringify(m)); }catch(e){} }
    function loadActive(){ try{ return JSON.parse(localStorage.getItem(activeKey)||'null'); }catch(e){ return null } }
    function saveActive(i){ try{ localStorage.setItem(activeKey,JSON.stringify(i)); }catch(e){} }
    function clearAllStorage(){ localStorage.removeItem(assignKey); localStorage.removeItem(activeKey); }
    function fetchOptions(cb){ cb(OPTIONS_FALLBACK); }

    /* å»ºç›¤ */
    function buildBoard(options){
      var board=document.getElementById('board');
      board.innerHTML='';
      var assign=loadAssign();
      var active=loadActive();

      var CELL_NAMES = [
        "7è™Ÿ", "8è™Ÿ", "9è™Ÿ",
        "4è™Ÿ", "ç¥­å£‡", "6è™Ÿ",
        "1è™Ÿ", "2è™Ÿ", "3è™Ÿ"
      ];

      for(var idx=0; idx<TOTAL; idx++){
        (function(i){
          var cell=document.createElement('div'); cell.className='cell'; cell.dataset.idx=i;
          /* ä¾ row/col ä½ˆå±€ï¼šrow = Math.floor(i/3)+1, col = (i%3)+1 */
          cell.style.gridRow = (Math.floor(i/3)+1);
          cell.style.gridColumn = ((i%3)+1);

          var title=document.createElement('div'); title.className='title';
          title.textContent = CELL_NAMES[i] || ('æ ¼ ' + (i+1));
          var imgbox=document.createElement('div'); imgbox.className='imgbox';
          var img=document.createElement('img'); img.alt=''; imgbox.appendChild(img);
          var clear=document.createElement('button'); clear.className='clear'; clear.textContent='âœ•';

          cell.appendChild(title); cell.appendChild(imgbox); cell.appendChild(clear);
          board.appendChild(cell);

          if(i===4){ // ä¸­é–“æ ¼å›ºå®šç¥­å£‡
            img.src='images/ç¥­å£‡.png';
            clear.style.display='none';
            cell.classList.add('fixed');
          }else{
            cell.addEventListener('click',function(e){ if(e.target===clear)return; setActive(i); });
            clear.addEventListener('click',function(){ clearCell(i,options); });
            if(assign[i]){
              var opt=findByName(options,assign[i]);
              if(opt){ img.src=opt.image; }
            }
          }
        })(idx);
      }

      /* åœ¨ç¬¬4æ¬„æ”¾ç½®ä¸‰é¡†è¡Œåˆ¥æŒ‰éˆ•ï¼šä¸Š/ä¸­/ä¸‹ */
      var btnTop=document.createElement('button');
      btnTop.className='rowcopy'; btnTop.textContent='è¤‡è£½ä¸Šæ’';
      btnTop.style.gridColumn='4'; btnTop.style.gridRow='1';
      btnTop.addEventListener('click', ()=>copyLine(0));
      board.appendChild(btnTop);

      var btnMid=document.createElement('button');
      btnMid.className='rowcopy'; btnMid.textContent='è¤‡è£½ä¸­æ’';
      btnMid.style.gridColumn='4'; btnMid.style.gridRow='2';
      btnMid.addEventListener('click', ()=>copyLine(1));
      board.appendChild(btnMid);

      var btnBot=document.createElement('button');
      btnBot.className='rowcopy'; btnBot.textContent='è¤‡è£½ä¸‹æ’';
      btnBot.style.gridColumn='4'; btnBot.style.gridRow='3';
      btnBot.addEventListener('click', ()=>copyLine(2));
      board.appendChild(btnBot);

      if(active==null) setActive(0); else highlightActive(active);
      renderPool(options);
    }

    /* è¼”åŠ© */
    function findByName(opts,name){ return opts.find(o=>o.name===name); }
    function setActive(i){ saveActive(i); highlightActive(i); }
    function highlightActive(i){
      document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active'));
      var t=document.querySelector('.cell[data-idx="'+i+'"]'); if(t) t.classList.add('active');
    }

    /* å€™é¸æ±  */
    function renderPool(options){
      var host=document.getElementById('opts'); host.innerHTML='';
      var used={}, asn=loadAssign(); for(var k in asn){ used[asn[k]]=true; }

      options.forEach(function(opt){
        var card=document.createElement('div'); card.className='opt'+(used[opt.name]?' used':''); card.dataset.name=opt.name;
        var pic=document.createElement('div'); pic.className='pic';
        var img=document.createElement('img'); img.src=opt.image; pic.appendChild(img);
        var nm=document.createElement('div'); nm.className='name'; nm.textContent=opt.name;
        card.appendChild(pic); card.appendChild(nm);
        host.appendChild(card);

        card.addEventListener('click',function(){
          if(card.classList.contains('used'))return;
          var act=loadActive(); if(act==null) act=0;
          if(act===4)return; // ä¸­é–“æ ¼ç¦æ­¢
          assignToCell(act,opt.name,options);
        });
      });
    }

    function assignToCell(i,name,options){
      var asn=loadAssign(); asn[i]=name; saveAssign(asn);
      var cell=document.querySelector('.cell[data-idx="'+i+'"] img'); var opt=findByName(options,name);
      if(cell&&opt) cell.src=opt.image;
      renderPool(options);
      var next=[...Array(TOTAL).keys()].find(j=>!asn[j] && j!==4);
      if(next!=null) setActive(next);
    }

    function clearCell(i,options){
      var asn=loadAssign(); delete asn[i]; saveAssign(asn);
      var cell=document.querySelector('.cell[data-idx="'+i+'"] img'); if(cell) cell.src='';
      renderPool(options);
    }

    function clearAll(options){
      clearAllStorage();
      document.querySelectorAll('.cell img').forEach((im,idx)=>{ if(idx!==4) im.src=''; });
      renderPool(options);
      setActive(0);
    }

    /* ç”¢ç”Ÿä¸‰è¡Œå ±ä½æ–‡å­—ï¼ˆç„¡æ™‚é–“ã€ç„¡å‰ç¶´ï¼‰ */
    function buildReportLines() {
      const asn = loadAssign();
      const DIR = ["â†–","â†‘","â†—","â†","","â†’","â†™","â†“","â†˜"];   // å„æ ¼æ–¹å‘
      const NUM = ["7","8","9","4","5","6","1","2","3"]; // å„æ ¼æ•¸å­—

      function fmt(i) {
        if (i === 4) return NUM[i] + "ç¥­å£‡";
        const full = asn[i];
        const short = full ? (NAME_SHORT[full] || full) : "ç©º";
        return NUM[i] + short + DIR[i];
      }

      const line1 = [0,1,2].map(fmt).join(' ');
      const line2 = [3,4,5].map(fmt).join(' ');
      const line3 = [6,7,8].map(fmt).join(' ');
      return [line1, line2, line3];
    }
    function copyLine(idx) {
      const lines = buildReportLines();
      navigator.clipboard.writeText(lines[idx]).then(()=>{ alert(`å·²è¤‡è£½${idx===0?'ä¸Š':idx===1?'ä¸­':'ä¸‹'}æ’`); });
    }
    function copyAllLines() {
      const lines = buildReportLines();
      navigator.clipboard.writeText(lines.join('\n')).then(()=>{ alert("ä¸‰è¡Œå·²è¤‡è£½"); });
    }

    /* ç¶å®šèˆ‡å•Ÿå‹• */
    document.getElementById('copyAll').addEventListener('click', copyAllLines);
    document.getElementById('clearAll').addEventListener('click',()=>fetchOptions(opts=>clearAll(opts)));
    fetchOptions(opts=>buildBoard(opts));

    /* ä¸»é¡Œåˆ‡æ›ï¼ˆé è¨­æ·±è‰²ï¼‰ */
    (function(){
      var themeKey='mc_theme';
      function applyTheme(t){
        document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark');
        var icon=document.getElementById('themeIcon'); if(icon) icon.textContent=(t==='light'?'â˜€ï¸':'ğŸŒ™');
        var text=document.getElementById('themeText'); if(text) text.textContent=(t==='light'?'æ·ºè‰²':'æ·±è‰²');
        try{ localStorage.setItem(themeKey,t); }catch(e){}
      }
      var saved=null; try{ saved=localStorage.getItem(themeKey); }catch(e){}
      applyTheme(saved||'dark');
      var btn=document.getElementById('themeToggle');
      if(btn){ btn.addEventListener('click', function(){
        var cur=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark';
        applyTheme(cur==='light'?'dark':'light');
      }); }
    })();
  </script>
</body>
</html>
