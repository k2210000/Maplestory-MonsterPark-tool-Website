<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>終極怪物公園-工具</title>
  <style>
    :root{
      --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa4b2; --card:#13161c; --card-border:#242a36; --well:#0c0f14;
      --cell:220px; --gap:12px; --radius:14px;
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --fg:#0e1116; --muted:#596273; --card:#ffffff; --card-border:#dfe5ee; --well:#f1f4f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans TC",Arial}
    header{padding:16px 20px;border-bottom:1px solid var(--card-border);position:sticky;top:0;background:rgba(15,17,21,.8);backdrop-filter:blur(8px);display:flex;align-items:center;gap:12px;z-index:2}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .spacer{flex:1}
    button{background:var(--card);color:var(--fg);border:1px solid var(--card-border);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    button:hover{filter:brightness(1.05)}

    main{padding:20px;display:grid;grid-template-columns: 1fr max-content;gap:20px}
    @media (max-width: 1100px){ main{grid-template-columns: 1fr} }

    /* 九宮格盤面 */
    .board{display:grid;grid-template-columns:repeat(3,var(--cell));grid-template-rows:repeat(3,var(--cell));gap:var(--gap);justify-content:center}
    .cell{width:var(--cell);height:var(--cell);background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:10px;position:relative;display:flex;flex-direction:column}
    .cell.active{outline:2px solid #6aa3ff; outline-offset:2px}
    .title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .imgbox{flex:1;display:grid;place-items:center;background:var(--well);border-radius:10px;overflow:hidden;border:1px dashed var(--card-border)}
    .imgbox img{max-width:100%;max-height:100%;object-fit:contain}
    .clear{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center}

    /* 右側候選區（左下角拖曳把手、縮圖隨寬度變動） */
    .pool{position: sticky;top: 76px;background: var(--card);border: 1px solid var(--card-border);border-radius: var(--radius);padding: 12px;resize: both;overflow: auto;direction: rtl;}
    .pool * {direction: ltr;}
    .assign-resizable{width:340px;min-width:260px;max-width:48vw;min-height:240px;max-height:80vh;resize: both;overflow: auto;container-type: inline-size;--tile-size: clamp(88px, 28cqw, 160px);}
    .opts{display:grid;gap:10px;grid-template-columns: repeat(auto-fill, minmax(var(--tile-size), 1fr));}
    .opt{border:1px solid var(--card-border);border-radius:12px;padding:6px;display:flex;flex-direction:column;gap:6px;cursor:pointer;background:var(--well);position:relative}
    .opt .pic{aspect-ratio:1/1;display:grid;place-items:center;overflow:hidden;border-radius:8px;background:var(--card)}
    .opt img{max-width:100%;max-height:100%;object-fit:contain}
    .opt .name{font-size:12px;color:var(--fg);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .opt.used{opacity:.35;filter:saturate(.2);cursor:not-allowed}
    .opt.used::after{content:'已用';position:absolute;top:6px;right:6px;font-size:10px;background:#0008;padding:2px 6px;border-radius:999px;border:1px solid var(--card-border)}

    .theme-toggle{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:3}
    .theme-toggle .icon{font-size:16px}
  </style>
</head>
<body>
  <header>
    <h1>終極怪物公園-工具</h1>
    <div class="spacer"></div>

    <button id="copyTop">複製上排</button>
    <button id="copyMid">複製中排</button>
    <button id="copyBot">複製下排</button>
    <button id="copyAll">複製全部</button>

    <button id="clearAll">清空全部</button>
  </header>

  <main>
    <section>
      <div class="board" id="board"></div>
    </section>
    <aside>
      <div class="pool assign-resizable">
        <h2>可選項目（點一下指派）</h2>
        <div class="opts" id="opts"></div>
      </div>
    </aside>
  </main>

  <button id="themeToggle" class="theme-toggle" title="切換深/淺色主題">
    <span class="icon" id="themeIcon">🌙</span>
    <span id="themeText">深色</span>
  </button>

  <script>
    /* 基本資料 */
    var TOTAL=9;
    var OPTIONS_FALLBACK = [
      { "id": 1, "name": "未知的精銳劍齒虎", "image": "images/未知的精銳劍齒虎.png" },
      { "id": 2, "name": "未知的始祖鳥",     "image": "images/未知的始祖鳥.png" },
      { "id": 3, "name": "未知的變異史萊姆", "image": "images/未知的變異史萊姆.png" },
      { "id": 4, "name": "未知的雷電鳥",     "image": "images/未知的雷電鳥.png" },
      { "id": 5, "name": "未知的蝮蛇",       "image": "images/未知的蝮蛇.png" },
      { "id": 6, "name": "未知的綠水靈",     "image": "images/未知的綠水靈.png" },
      { "id": 7, "name": "未知的劍齒虎",     "image": "images/未知的劍齒虎.png" },
      { "id": 8, "name": "未知的毒蛇",       "image": "images/未知的毒蛇.png" }
    ];

    /* 狀態儲存 */
    var assignKey='mch_assign';
    var activeKey='mch_active';
    function loadAssign(){ try{ return JSON.parse(localStorage.getItem(assignKey)||'{}'); }catch(e){ return {}; } }
    function saveAssign(m){ try{ localStorage.setItem(assignKey,JSON.stringify(m)); }catch(e){} }
    function loadActive(){ try{ return JSON.parse(localStorage.getItem(activeKey)||'null'); }catch(e){ return null } }
    function saveActive(i){ try{ localStorage.setItem(activeKey,JSON.stringify(i)); }catch(e){} }
    function clearAllStorage(){ localStorage.removeItem(assignKey); localStorage.removeItem(activeKey); }

    /* 主題切換（預設深色） */
    (function(){
      var themeKey='mc_theme';
      function applyTheme(t){
        document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark');
        var icon=document.getElementById('themeIcon'); if(icon) icon.textContent=(t==='light'?'☀️':'🌙');
        var text=document.getElementById('themeText'); if(text) text.textContent=(t==='light'?'淺色':'深色');
        try{ localStorage.setItem(themeKey,t); }catch(e){}
      }
      var saved=null; try{ saved=localStorage.getItem(themeKey); }catch(e){}
      applyTheme(saved||'dark');
      var btn=document.getElementById('themeToggle');
      if(btn){ btn.addEventListener('click', function(){
        var cur=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark';
        applyTheme(cur==='light'?'dark':'light');
      }); }
    })();

    /* 初始化資料來源（這裡直接用內建 fallback） */
    function fetchOptions(cb){ cb(OPTIONS_FALLBACK); }

    /* 建盤 */
    function buildBoard(options){
      var board=document.getElementById('board');
      board.innerHTML='';
      var assign=loadAssign();
      var active=loadActive();

      var CELL_NAMES = [
        "7號", "8號", "9號",
        "4號", "祭壇", "6號",
        "1號", "2號", "3號"
      ];

      for(var idx=0; idx<TOTAL; idx++){
        (function(i){
          var cell=document.createElement('div'); cell.className='cell'; cell.dataset.idx=i;
          var title=document.createElement('div'); title.className='title';
          title.textContent = CELL_NAMES[i] || ('格 ' + (i+1));
          var imgbox=document.createElement('div'); imgbox.className='imgbox';
          var img=document.createElement('img'); img.alt=''; imgbox.appendChild(img);
          var clear=document.createElement('button'); clear.className='clear'; clear.textContent='✕';

          cell.appendChild(title); cell.appendChild(imgbox); cell.appendChild(clear);
          board.appendChild(cell);

          if(i===4){ // 中間格固定祭壇
            img.src='images/祭壇.png';
            clear.style.display='none'; // 不能清除
            cell.classList.add('fixed');
            return;
          }

          cell.addEventListener('click',function(e){ if(e.target===clear)return; setActive(i); });
          clear.addEventListener('click',function(){ clearCell(i,options); });

          if(assign[i]){
            var opt=findByName(options,assign[i]);
            if(opt){ img.src=opt.image; }
          }
        })(idx);
      }

      if(active==null) setActive(0); else highlightActive(active);
      renderPool(options);
    }

    /* 輔助 */
    function findByName(opts,name){ return opts.find(o=>o.name===name); }
    function setActive(i){ saveActive(i); highlightActive(i); }
    function highlightActive(i){
      document.querySelectorAll('.cell').forEach(c=>c.classList.remove('active'));
      var t=document.querySelector('.cell[data-idx="'+i+'"]'); if(t) t.classList.add('active');
    }

    /* 候選池 */
    function renderPool(options){
      var host=document.getElementById('opts'); host.innerHTML='';
      var used={}, asn=loadAssign(); for(var k in asn){ used[asn[k]]=true; }

      options.forEach(function(opt){
        var card=document.createElement('div'); card.className='opt'+(used[opt.name]?' used':''); card.dataset.name=opt.name;
        var pic=document.createElement('div'); pic.className='pic';
        var img=document.createElement('img'); img.src=opt.image; pic.appendChild(img);
        var nm=document.createElement('div'); nm.className='name'; nm.textContent=opt.name;
        card.appendChild(pic); card.appendChild(nm);
        host.appendChild(card);

        card.addEventListener('click',function(){
          if(card.classList.contains('used'))return;
          var act=loadActive(); if(act==null) act=0;
          if(act===4)return; // 中間格禁止
          assignToCell(act,opt.name,options);
        });
      });
    }

    function assignToCell(i,name,options){
      var asn=loadAssign(); asn[i]=name; saveAssign(asn);
      var cell=document.querySelector('.cell[data-idx="'+i+'"] img'); var opt=findByName(options,name);
      if(cell&&opt) cell.src=opt.image;
      renderPool(options);
      var next=[...Array(TOTAL).keys()].find(j=>!asn[j] && j!==4);
      if(next!=null) setActive(next);
    }

    function clearCell(i,options){
      var asn=loadAssign(); delete asn[i]; saveAssign(asn);
      var cell=document.querySelector('.cell[data-idx="'+i+'"] img'); if(cell) cell.src='';
      renderPool(options);
    }

    function clearAll(options){
      clearAllStorage();
      document.querySelectorAll('.cell img').forEach((im,idx)=>{ if(idx!==4) im.src=''; });
      renderPool(options);
      setActive(0);
    }

    /* 複製報位 */
    // 產生三行報位文字（自動帶入當下時間 [HH:mm]）
    function buildReportLines() {
      const asn = loadAssign();
      const DIR = ["↖","↑","↗","←","","→","↙","↓","↘"]; // 各格方向
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const timeStr = `[${hh}:${mm}]`;

      function fmt(i) {
        if (i === 4) return "祭壇"; // 中間固定
        return (asn[i] ? asn[i] : "空") + DIR[i];
      }

      const line1 = `${timeStr}報位小幫手：${[0,1,2].map(fmt).join(' ')}`;
      const line2 = `${timeStr}報位小幫手：${[3,4,5].map(fmt).join(' ')}`;
      const line3 = `${timeStr}報位小幫手：${[6,7,8].map(fmt).join(' ')}`;

      return [line1, line2, line3];
    }

    function copyLine(idx) {
      const lines = buildReportLines();
      navigator.clipboard.writeText(lines[idx]).then(()=>{
        alert(`已複製：${idx===0?'上排':idx===1?'中排':'下排'}`);
      });
    }

    function copyAllLines() {
      const lines = buildReportLines();
      navigator.clipboard.writeText(lines.join('\n')).then(()=>{
        alert("三行報位已複製！");
      });
    }

    /* 綁定與啟動 */
    document.getElementById('copyTop').addEventListener('click', () => copyLine(0));
    document.getElementById('copyMid').addEventListener('click', () => copyLine(1));
    document.getElementById('copyBot').addEventListener('click', () => copyLine(2));
    document.getElementById('copyAll').addEventListener('click', copyAllLines);
    document.getElementById('clearAll').addEventListener('click',()=>fetchOptions(opts=>clearAll(opts)));
    fetchOptions(opts=>buildBoard(opts));
  </script>
</body>
</html>
