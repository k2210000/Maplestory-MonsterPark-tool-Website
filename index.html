<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çµ‚æ¥µæ€ªç‰©å…¬åœ’-å·¥å…·</title>
  <style>
    :root{
      --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa4b2; --card:#13161c; --card-border:#242a36; --well:#0c0f14;
      --cell:220px; --gap:12px; --radius:14px;
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --fg:#0e1116; --muted:#596273; --card:#ffffff; --card-border:#dfe5ee; --well:#f1f4f9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans TC",Arial}
    header{padding:16px 20px;border-bottom:1px solid var(--card-border);position:sticky;top:0;background:rgba(15,17,21,.8);backdrop-filter:blur(8px);display:flex;align-items:center;gap:12px;z-index:2}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .spacer{flex:1}
    button{background:var(--card);color:var(--fg);border:1px solid var(--card-border);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    button:hover{filter:brightness(1.05)}

    /* ä¸»è¦ç‰ˆé¢ï¼šå·¦ç›¤é¢ + å³å´å¯é¸å€ã€‚å³å´æ¡ max-content ä»¥æ”¯æ´æ‹–æ›³è®Šå¯¬ */
    main{padding:20px;display:grid;grid-template-columns: 1fr max-content;gap:20px}
    @media (max-width: 1100px){ main{grid-template-columns: 1fr} }

    /* ç›¤é¢ï¼š3 | 2 | 3 ç›´æ’æ¬„ */
    .board{display:flex;gap:var(--gap);justify-content:center;align-items:flex-start;flex-wrap:nowrap;overflow-x:auto}
    .col{display:flex;flex-direction:column;gap:var(--gap)}
    .col.middle{margin-top:calc((var(--cell) + var(--gap)) / 2)}
    .cell{width:var(--cell);height:var(--cell);background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:10px;position:relative;display:flex;flex-direction:column}
    .cell.active{outline:2px solid #6aa3ff; outline-offset:2px}
    .title{font-size:12px;color:var(--muted);margin-bottom:6px}
    .imgbox{flex:1;display:grid;place-items:center;background:var(--well);border-radius:10px;overflow:hidden;border:1px dashed var(--card-border)}
    .imgbox img{max-width:100%;max-height:100%;object-fit:contain;image-rendering:auto}
    .clear{position:absolute;top:8px;right:8px;width:30px;height:30px;border-radius:999px;display:grid;place-items:center}

    /* å³å´é¸æ“‡æ± ï¼ˆå¯é»ï¼‰ + å¯æ‹–æ›³èª¿æ•´å¤§å° */
    .pool{
    position: sticky;
    top: 76px;
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 12px;

    resize: both;
    overflow: auto;

    direction: rtl; /* æŠŠ resize æ‰‹æŠŠæ”¾åˆ°å·¦ä¸‹è§’ */
    }
    .pool * {
      direction: ltr; /* è£¡é¢çš„æ–‡å­—ä¿æŒæ­£å¸¸ */
    }
    .opts{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(auto-fill, minmax(var(--tile-size), 1fr));
    }
    .opt{border:1px solid var(--card-border);border-radius:12px;padding:6px;display:flex;flex-direction:column;gap:6px;cursor:pointer;background:var(--well);position:relative}
    .opt .pic{aspect-ratio:1/1;display:grid;place-items:center;overflow:hidden;border-radius:8px;background:var(--card)}
    .opt img{max-width:100%;max-height:100%;object-fit:contain}
    .opt .name{font-size:12px;color:var(--fg);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .opt.used{opacity:.35;filter:saturate(.2);cursor:not-allowed}
    .opt.used::after{content:'å·²ç”¨';position:absolute;top:6px;right:6px;font-size:10px;background:#0008;padding:2px 6px;border-radius:999px;border:1px solid var(--card-border)}

    /* è®“å³å´æ•´å¡Šå¯æ‹–æ›³ç¸®æ”¾ */
    .assign-resizable{
      width:340px;
      min-width:260px;
      max-width:48vw;
      min-height:240px;
      max-height:80vh;
      resize: both;
      overflow: auto;

      /* æ–°å¢ï¼šæŠŠå³å´é¢æ¿ç•¶ä½œã€Œå®¹å™¨ã€ä¾†é‡å°ºå¯¸ */
      container-type: inline-size;

      /* æ–°å¢ï¼šæ¯å€‹ç¸®åœ–çš„åŸºæº–å°ºå¯¸ï¼Œæœƒéš¨é¢æ¿å¯¬åº¦è®ŠåŒ–
         1cqw = å®¹å™¨å¯¬åº¦çš„ 1%  */
      --tile-size: clamp(88px, 28cqw, 160px);
    }


    .theme-toggle{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:10px 12px;display:flex;align-items:center;gap:8px;z-index:3}
    .theme-toggle .icon{font-size:16px}
  </style>
</head>
<body>
  <header>
    <h1>çµ‚æ¥µæ€ªç‰©å…¬åœ’-å·¥å…·</h1>
    <div class="spacer"></div>
    <button id="clearAll">æ¸…ç©ºå…¨éƒ¨</button>
  </header>

  <main>
    <section>
      <div class="board" id="board" aria-live="polite"></div>
    </section>
    <aside>
      <!-- åŠ ä¸Š assign-resizable è®“æ•´å¡Šå¯ä»¥æ‹–æ›³æ”¾å¤§ç¸®å° -->
      <div class="pool assign-resizable">
        <h2>å¯é¸é …ç›®ï¼ˆé»ä¸€ä¸‹æŒ‡æ´¾ï¼‰</h2>
        <div class="opts" id="opts"></div>
      </div>
    </aside>
  </main>

  <button id="themeToggle" class="theme-toggle" title="åˆ‡æ›æ·±/æ·ºè‰²ä¸»é¡Œ">
    <span class="icon" id="themeIcon">ğŸŒ™</span>
    <span id="themeText">æ·±è‰²</span>
  </button>

  <script>
    /* ===== ä¸»é¡Œï¼ˆé è¨­æ·±è‰²ï¼‰ ===== */
    (function(){
      var themeKey='mc_theme';
      function applyTheme(t){
        document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark');
        var icon=document.getElementById('themeIcon'); if(icon) icon.textContent=(t==='light'?'â˜€ï¸':'ğŸŒ™');
        var text=document.getElementById('themeText'); if(text) text.textContent=(t==='light'?'æ·ºè‰²':'æ·±è‰²');
        try{ localStorage.setItem(themeKey,t); }catch(e){}
      }
      var saved=null; try{ saved=localStorage.getItem(themeKey); }catch(e){}
      applyTheme(saved||'dark');
      var btn=document.getElementById('themeToggle');
      if(btn){ btn.addEventListener('click', function(){
        var cur=(document.documentElement.getAttribute('data-theme')==='light')?'light':'dark';
        applyTheme(cur==='light'?'dark':'light');
      }); }
    })();

    /* ===== å›ºå®šè³‡æ–™ ===== */
    var LAYOUT=[3,2,3]; // ç›´æ’ 3 | 2 | 3
    var TOTAL=(function(){ var s=0; for(var i=0;i<LAYOUT.length;i++) s+=LAYOUT[i]; return s; })();
    var OPTIONS_FALLBACK = [
      { "id": 1, "name": "æœªçŸ¥çš„ç²¾éŠ³åŠé½’è™", "image": "images/æœªçŸ¥çš„ç²¾éŠ³åŠé½’è™.png" },
      { "id": 2, "name": "æœªçŸ¥çš„å§‹ç¥–é³¥",     "image": "images/æœªçŸ¥çš„å§‹ç¥–é³¥.png" },
      { "id": 3, "name": "æœªçŸ¥çš„è®Šç•°å²èŠå§†", "image": "images/æœªçŸ¥çš„è®Šç•°å²èŠå§†.png" },
      { "id": 4, "name": "æœªçŸ¥çš„é›·é›»é³¥",     "image": "images/æœªçŸ¥çš„é›·é›»é³¥.png" },
      { "id": 5, "name": "æœªçŸ¥çš„è—è›‡",       "image": "images/æœªçŸ¥çš„è—è›‡.png" },
      { "id": 6, "name": "æœªçŸ¥çš„ç¶ æ°´éˆ",     "image": "images/æœªçŸ¥çš„ç¶ æ°´éˆ.png" },
      { "id": 7, "name": "æœªçŸ¥çš„åŠé½’è™",     "image": "images/æœªçŸ¥çš„åŠé½’è™.png" },
      { "id": 8, "name": "æœªçŸ¥çš„æ¯’è›‡",       "image": "images/æœªçŸ¥çš„æ¯’è›‡.png" }
    ];

    // ç‹€æ…‹ï¼šæ¯å€‹ cell æŒ‡æ´¾åˆ°å“ªå€‹ option.nameï¼›ä»¥åŠç›®å‰ä½œç”¨ä¸­çš„ cell
    var assignKey='mch_4224_assign';
    var activeKey='mch_4224_active';
    function loadAssign(){ try{ return JSON.parse(localStorage.getItem(assignKey)||'null')||{} }catch(e){ return {} } }
    function saveAssign(map){ try{ localStorage.setItem(assignKey, JSON.stringify(map)); }catch(e){} }
    function loadActive(){ try{ return JSON.parse(localStorage.getItem(activeKey)||'null') }catch(e){ return null } }
    function saveActive(i){ try{ localStorage.setItem(activeKey, JSON.stringify(i)); }catch(e){} }
    function clearAllStorage(){ try{ localStorage.removeItem(assignKey); localStorage.removeItem(activeKey);}catch(e){} }

    function fetchOptions(cb){
      if(location.protocol==='http:'||location.protocol==='https:'){
        fetch('options.json?v='+Date.now())
          .then(function(r){ if(!r.ok) throw new Error('fetch options.json failed'); return r.json(); })
          .then(function(data){ if(!Array.isArray(data)) throw new Error('bad json'); cb(data); })
          .catch(function(){ cb(OPTIONS_FALLBACK); });
      }else{ cb(OPTIONS_FALLBACK); }
    }

    function buildBoard(options){
      var board=document.getElementById('board');
      board.innerHTML='';
      var assign=loadAssign();
      var active=loadActive();
      var cellIndex=0;

      for(var col=0; col<LAYOUT.length; col++){
        var colEl=document.createElement('div'); colEl.className='col'+(col===1?' middle':'');
        for(var r=0; r<LAYOUT[col]; r++){
          (function(idx){
            var cell=document.createElement('div'); cell.className='cell'; cell.setAttribute('data-idx', idx);
            if(active===idx) cell.classList.add('active');
            var title=document.createElement('div'); title.className='title'; title.textContent='æ ¼ '+(idx+1);
            var imgbox=document.createElement('div'); imgbox.className='imgbox';
            var img=document.createElement('img'); img.alt=''; imgbox.appendChild(img);
            var clear=document.createElement('button'); clear.className='clear'; clear.innerHTML='âœ•'; clear.title='æ¸…é™¤æ­¤æ ¼';

            cell.appendChild(title); cell.appendChild(imgbox); cell.appendChild(clear);
            colEl.appendChild(cell);

            // é»æ“Š cell â†’ è¨­ç‚ºä½œç”¨ä¸­
            cell.addEventListener('click', function(e){
              if(e.target===clear) return; // é¿å…æ¸…é™¤éˆ•å†’æ³¡
              setActive(idx);
            });
            // æ¸…é™¤æ­¤æ ¼
            clear.addEventListener('click', function(){ clearCell(idx, options); });

            // è‹¥æœ‰å·²æŒ‡æ´¾ï¼Œé¡¯ç¤ºåœ–ç‰‡
            var optName=assign[idx];
            if(optName){
              var opt=findByName(options, optName);
              if(opt && opt.image){ img.src=opt.image; img.style.display='block'; }
            }
          })(cellIndex++);
        }
        board.appendChild(colEl);
      }

      // é¦–æ¬¡æ²’æœ‰ä½œç”¨æ ¼ï¼Œé è¨­ç¬¬ä¸€å€‹ç©ºæ ¼
      if(loadActive()==null){
        var firstEmpty=findFirstEmpty(assign);
        setActive(firstEmpty!=null?firstEmpty:0);
      } else {
        highlightActive(loadActive());
      }

      renderPool(options);
    }

    function findByName(options, name){
      for(var i=0;i<options.length;i++) if(options[i].name===name) return options[i];
      return null;
    }

    function currentAssign(){ return loadAssign(); }

    function setActive(idx){
      saveActive(idx);
      highlightActive(idx);
    }

    function highlightActive(idx){
      var cells=document.querySelectorAll('.cell');
      for(var i=0;i<cells.length;i++) cells[i].classList.remove('active');
      var target=document.querySelector('.cell[data-idx="'+idx+'"]');
      if(target) target.classList.add('active');
    }

    function findFirstEmpty(assign){
      for(var i=0;i<TOTAL;i++) if(!assign[i]) return i; return null;
    }

    function renderPool(options){
      var host=document.getElementById('opts'); host.innerHTML='';
      var usedNames={}; var asn=currentAssign();
      for(var k in asn){ if(asn[k]) usedNames[asn[k]]=true; }

      for(var i=0;i<options.length;i++){
        (function(opt){
          var card=document.createElement('div'); card.className='opt'+(usedNames[opt.name]?' used':''); card.setAttribute('data-name', opt.name);
          var pic=document.createElement('div'); pic.className='pic';
          var img=document.createElement('img'); img.alt=opt.name; img.src=opt.image; pic.appendChild(img);
          var nm=document.createElement('div'); nm.className='name'; nm.textContent=opt.name;
          card.appendChild(pic); card.appendChild(nm);
          host.appendChild(card);

          card.addEventListener('click', function(){
            if(card.classList.contains('used')) return; // ä¸èƒ½é‡è¤‡
            var act=loadActive(); if(act==null) setActive(0), act=0;
            assignToCell(act, opt.name, options);
          });
        })(options[i]);
      }
    }

    function assignToCell(idx, optName, options){
      var asn=loadAssign();
      asn[idx]=optName; // è¨­å®šæ–°æŒ‡æ´¾
      saveAssign(asn);

      // æ›´æ–°è©² cell åœ–ç‰‡
      var cell=document.querySelector('.cell[data-idx="'+idx+'"]');
      if(cell){
        var img=cell.querySelector('img');
        var opt=findByName(options, optName);
        if(img && opt && opt.image){ img.src=opt.image; img.style.display='block'; }
      }

      // é‡æ–°æ¸²æŸ“æ± ï¼ˆè®“æ–°æŒ‡æ´¾çš„é¸é …è®Šæˆ usedï¼‰
      renderPool(options);

      // è‡ªå‹•ç§»åˆ°ä¸‹ä¸€å€‹ç©ºæ ¼
      var next=findFirstEmpty(asn);
      if(next!=null) setActive(next);
    }

    function clearCell(idx, options){
      var asn=loadAssign();
      if(asn[idx]){
        delete asn[idx];
        saveAssign(asn);
      }
      // æ¸…åœ–
      var cell=document.querySelector('.cell[data-idx="'+idx+'"]');
      if(cell){ var img=cell.querySelector('img'); if(img){ img.src=''; img.style.display='none'; } }
      // æ›´æ–°æ± 
      renderPool(options);
    }

    function clearAll(options){
      clearAllStorage();
      var imgs=document.querySelectorAll('.cell img'); for(var i=0;i<imgs.length;i++){ imgs[i].src=''; imgs[i].style.display='none'; }
      renderPool(options);
      setActive(0);
    }

    // ========= å•Ÿå‹• =========
    document.getElementById('clearAll').addEventListener('click', function(){ fetchOptions(function(opts){ clearAll(opts); }); });
    fetchOptions(function(opts){ buildBoard(opts); });
  </script>
</body>
</html>
